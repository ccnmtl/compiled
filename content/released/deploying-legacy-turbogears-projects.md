---
author_name: "Ethan Jucovy"
author_url: "https://github.com/ejucovy/"
date: "2011-04-21"
tags: ["deployment", "process", "python", "turbogears"]
title: "Python Deployment Chronicles: Deploying legacy TurboGears projects with modern tools"
type: "post"
---

<p>At <span class="caps">CCNMTL </span>most of our new Python projects are written in Django, but we still support a number of older projects that were written with TurboGears 1.0.4.  They've continued to be stable, and we don't do a ton of new development on them, so it hasn't been worthwhile to upgrade them to newer versions of TurboGears.</p><p>But we do occasionally make changes to their code, and recently we've begun migrating them to newer servers. &nbsp;So I recently spent some time updating their deployment processes to <span class="caps">CCNMTL'</span>s current best practices:</p>

<!--more-->

<p></p><ul><li><meta http-equiv="content-type" content="text/html; charset=utf-8">Installation with pip instead of easy_install</li><li><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta http-equiv="content-type" content="text/html; charset=utf-8">Fully pinned local source distributions versioned alongside the code</li><li><meta http-equiv="content-type" content="text/html; charset=utf-8">No Internet access required anywhere in the deployment</li><li>Containment with virtualenv</li></ul><div>I ended up with a package that you can use to create an isolated TurboGears 1.0.4 environment to run legacy projects in, or (if for some reason you want to) to create new TurboGears 1.0.4 projects. &nbsp;You can get it on Github here:&nbsp;<a href="https://github.com/ccnmtl/turbogears_pip_bootstrapper">https://github.com/ccnmtl/turbogears_pip_bootstrapper</a></div><div><br /></div><div>In this post I'll go into detail about what it does, and the hurdles I ran into along the way.</div><meta http-equiv="content-type" content="text/html; charset=utf-8"><p></p>

<p>Like <a href="https://github.com/ccnmtl/ccnmtldjango/">our Django bootstrap process</a>, this is a one-step installation procedure for creating an isolated TurboGears 1.0.4 environment. &nbsp;Just run <code>bootstrap.py</code> and you'll have a virtualenv in <code>./ve</code>, with all the packages you need to run or create a TurboGears 1.0.4 project.</p><p>(If you're curious what I'm upgrading this <i>from</i>,&nbsp;<a href="http://thraxil.org/users/anders/posts/2006/09/13/TurboGears-Deployment-with-supervisord-and-workingenv-py/">Anders has a post describing our historical TurboGears bootstrap process</a>.)</p><p><br /></p><h2>Switching from easy_install to pip</h2>

<h3>From Eggs to Tarballs</h3>

<meta http-equiv="content-type" content="text/html; charset=utf-8"><div>Until now, we were using&nbsp;<code style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-size: 1em; font-weight: normal; ">easy_install</code>&nbsp;to install the packages we needed. &nbsp;Switching to pip is usually straightforward, but we'd been bundling all our dependencies as eggs instead of source tarballs, and pip doesn't support installation from eggs.</div><div><br /></div><div>So the first step was collecting source tarballs for each of the eggs we were installing into a TurboGears environment. &nbsp;This was mostly just a matter of downloading the <code>.tar.gz</code> file from PyPI that corresponded to the exact version of the package we were installing from an egg. &nbsp;Some of them were hard to find or weren't on PyPI;&nbsp;<a href="http://files.turbogears.org/eggs/">http://files.turbogears.org/eggs/</a>&nbsp;and&nbsp;<a href="http://peak.telecommunity.com/snapshots/">http://peak.telecommunity.com/snapshots/</a>&nbsp;were&nbsp;helpful here too, and for one or two particularly stubborn dependencies I just had to get the right version from SVN and package it in a tarball myself.</div><div><br /></div><div>To speed up the process, I wrote <a href="https://gist.github.com/935032">a script that tries to find and download all the right tarballs</a>, given a directory of eggs. &nbsp;After a few iterations, that took me most of the way. &nbsp;I was able to find the rest by hand, and eventually I had all the source distributions I needed. &nbsp;(You can get them all <a href="https://github.com/ccnmtl/turbogears_pip_bootstrapper/tree/master/requirements/src">here</a>.)</div><div><br /></div><h3>The Requirements File</h3><div>The last step was writing a <a href="http://www.pip-installer.org/en/latest/requirement-format.html">pip requirements file</a> that listed all of the dependencies. &nbsp;This was tricky for two reasons:</div><div><br /></div><div><ol><li>The order that you list the requirements matters -- if package A depends on package B, you have to list A before B in your requirements file. &nbsp;Otherwise pip might end up downloading a copy of B from the Internet before it even sees that you've specified a local source distribution. &nbsp;We want to prevent deployments from requiring Internet access (and relying on PyPI uptime) -- and, most likely, you'll end up with the wrong version of package B installed.</li><li>We use a couple of TurboGears plugins, and those plugins try to <code>import turbogears</code> in their <code>setup.py</code> files -- meaning that you can't install them until <i>after</i>&nbsp;TurboGears itself is fully installed.</li></ol><div>For the former, it was -- again -- just a matter of time to get it right: run the bootrap script, see if pip tries to download any packages, reorder the lines in <code><a href="https://github.com/ccnmtl/turbogears_pip_bootstrapper/blob/master/requirements/libs.txt">requirements.txt</a></code>, and repeat until it all worked right. &nbsp;To make it a little easier, I passed an <code>--index-url=''</code>&nbsp;option to pip, which made it fail early and loudly the first time it tried to download anything. &nbsp;(<a href="http://ccnmtl.columbia.edu/compiled/process/preventing_network_access_with.html">I blogged about this trick for preventing pip network access</a> a few weeks ago.)</div></div><div><br /></div><div>For the latter, reordering the requirements file wasn't sufficient -- because pip runs <code>setup.py egg_info</code> on all packages in your requirements file before it runs <code>setup.py install</code> on any of them -- so when it got to the packages that tried to <code>import turbogears</code> in their <code>setup.py</code>, it failed with an <code>ImportError</code>. &nbsp;So I made <a href="https://github.com/ccnmtl/turbogears_pip_bootstrapper/blob/master/requirements/phasetwo.txt">a second requirements file</a>, and I ran <code>pip install</code> a second time to install these packages after TurboGears and <i>its</i>&nbsp;dependencies were all fully installed.</div><div><br /></div><div><br /></div><h2>Pinning Setuptools</h2><div>The only other tricky thing was getting the right version of setuptools installed. &nbsp;The version of TurboGears we're using relies on setuptools 0.6c8 -- versions later than that cause errors with static file serving and other things, because of changes in <code>pkg_resources</code>.</div><div><br /></div><div>Virtualenv is pretty opinionated about what version of setuptools it installs --&nbsp;<a href="https://github.com/pypa/virtualenv/issues/89">https://github.com/pypa/virtualenv/issues/89</a>&nbsp;has the details. &nbsp;For my purposes, the simplest thing to do was modify the copy of virtualenv.py I'm providing. &nbsp;I made <a href="https://github.com/ccnmtl/turbogears_pip_bootstrapper/compare/1d32c7...2d9ca7">a few changes to the file</a> so that, instead of saying "install setuptools <b>0.6c11 or greater</b>," it instead says "install setuptools <b>0.6c8</b> <b>exactly</b>." &nbsp;</div><div><br /></div><div>To prevent network access and ensure full version pinning, I also dropped in local copies of a setuptools 0.6c8 egg and a pip 1.0 tarball, and <a href="https://github.com/ccnmtl/turbogears_pip_bootstrapper/blob/master/bootstrap.py#L16">told virtualenv.py where to find them</a>.</div><div><br /></div><div>The resulting bootstrap repository can be dropped into all of our TurboGears 1.0.4 projects, letting us upgrade our builds to pip, virtualenv, source distributions, no dependency on Internet access, and full version pinning in a single step. &nbsp;In case anyone else has a similar need to modernize their deployment processes for a frozen TurboGears 1.0 project, we've <a href="https://github.com/ccnmtl/turbogears_pip_bootstrapper/">made the code available on Github</a>. &nbsp;Patches welcome!</div><meta http-equiv="content-type" content="text/html; charset=utf-8">
